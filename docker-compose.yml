services:
  database-maintenance-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: database-maintenance-service
    restart: unless-stopped

    env_file:
      - .env

    environment:
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      PORT: 3000
      CORS_ORIGIN: ${CORS_ORIGIN:-*}

      DB_SERVER: ${DB_SERVER}
      DB_PORT: ${DB_PORT:-1433}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      DB_ENCRYPT: ${DB_ENCRYPT:-true}
      TRUST_SERVER_CERTIFICATE: ${TRUST_SERVER_CERTIFICATE:-false}
      DB_CONNECT_TIMEOUT: ${DB_CONNECT_TIMEOUT:-30000}
      DB_REQUEST_TIMEOUT: ${DB_REQUEST_TIMEOUT:-900000}

    volumes:
      - ./logs:/app/logs

    expose:
      - "3000"

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - backend

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped

    ports:
      - "80:80"

    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro

    depends_on:
      database-maintenance-service:
        condition: service_healthy

    networks:
      - backend

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  backend:
    driver: bridge
